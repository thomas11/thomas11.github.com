<?xml version="1.0" encoding="UTF-8"?> <feed xmlns="http://www.w3.org/2005/Atom">
  <title>Thomas Kappler&#39;s site. Mostly programming and books. Category &#34;F#.&#34;</title>
  <link href="http://www.thomaskappler.net/..\thomas11.github.com\categories/F#/" rel="alternate"></link>
  <id>http://www.thomaskappler.net/..\thomas11.github.com\categories/F#/</id>
  <updated>2022-02-19T10:16:39-08:00</updated>
  <author>
   <name>Thomas Kappler</name>
   <uri>http://www.thomaskappler.net/</uri>
  </author>
  <entry>
   <title>A Twitter bot for COVID vaccination progress in F# on Azure Functions</title>
   <link href="http://www.thomaskappler.net/2022-02-19-fsharp-twitter-bot.html" rel="alternate"></link>
   <updated>2022-02-19T00:00:00Z</updated>
   <id>tag:www.thomaskappler.net,2022-02-19:/2022-02-19-fsharp-twitter-bot.html</id>
   <summary type="html">Some commentary and pointers on how I wrote my first F# program, a Twitter bot running on Azure Functions.</summary>
   <content type="html">&lt;h2&gt;About&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;Back in January 2021 I wrote a little Twitter bot, currently called &lt;a href=&#34;https://twitter.com/covid_vax_wa&#34;&gt;&lt;em&gt;COVID vaccination progress WA&lt;/em&gt;&lt;/a&gt;, that I never got around to blogging about. Here&amp;rsquo;s &lt;a href=&#34;https://github.com/thomas11/covid-vax-tracker&#34;&gt;the code&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;At the time I was looking for an excuse to use both F# and Azure Functions for a real project, and found it when I got frustrated navigating the Covid vaccination information to get the info I really wanted: how many people are completely vaccinated?&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;/static/posts/2022-02-19_fsharp_twitter_bot/Pasted image 20220217194812.png&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;The bot retrieves this number once a day from official CDC data and tweets it out. It can do so for any US state, but currently I&amp;rsquo;m doing only Washington and the USA as a whole. No one wants to get 51 tweets a day, and creating a bot per state is painful because it requires different Twitter accounts. I think? Didn&amp;rsquo;t research this much.&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;Twitter developer account vs bot account&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Creating a Twitter developer account was straightforward. There was just one surprisingly hidden bit of information. My developer account is my main Twitter account from which I tweet, which is probably not best practice, but I assume is the case for many hobby projects. But I want the bot to tweet on its own account, how do I do that? - &lt;a href=&#34;https://stackoverflow.com/questions/64188365/authenticate-twitter-bot-with-static-secrets/64195317#64195317&#34;&gt;Stackoverflow has the answer&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;F#, Azure Functions, and VS Code&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;Honestly, I don&amp;rsquo;t remember exactly how I created the project and set everything up, but it was fairly automated. Development on the Azure and F# tooling in VS code is very active anyway and things might be different from a year ago.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;I use &lt;a href=&#34;https://ionide.io/&#34;&gt;Ionide&lt;/a&gt; for F# development and installed the &amp;ldquo;Azure Functions&amp;rdquo; extension, basically following &lt;a href=&#34;https://docs.microsoft.com/en-us/azure/azure-functions/functions-develop-vs-code?tabs=csharp&#34;&gt;Develop Azure Functions by using Visual Studio Code&lt;/a&gt; . These instructions are for C# but they worked for F# as well, except I ran into an issue with a missing host.json solved by &lt;a href=&#34;https://stackoverflow.com/questions/60501474/why-host-json-not-being-copied-to-output-in-f-azure-functions-project&#34;&gt;adding an explicit copy in the fsproj file&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;The end result is a really nice and convenient integration into VS Code, where I can deploy the function and stream logs directly from a menu. Not exactly automated or reproducible or properly logged but just fine for a hobby project.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;/static/posts/2022-02-19_fsharp_twitter_bot/Pasted image 20220217211211.png&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;The other thing where the Microsoft docs were not clear to me was how exactly the Key Vault integration worked, which I needed for the Twitter API secrets. Daniel&amp;rsquo;s &lt;a href=&#34;https://daniel-krzyczkowski.github.io/Integrate-Key-Vault-Secrets-With-Azure-Functions/&#34;&gt;How to keep secrets safe using Key Vault&lt;/a&gt; cleared that up quickly.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;The function runs on a schedule, which is defined directly on its entry point:&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;[&amp;lt;FunctionName(&amp;quot;TweetCdcDataTimer&amp;quot;)&amp;gt;]&#xA;// 8p EST = 1a UTC&#xA;let runTimer ([&amp;lt;TimerTrigger(&amp;quot;0 0 1 * * *&amp;quot;)&amp;gt;] myTimer: TimerInfo, log: ILogger) =&#xA;    let msg =&#xA;        sprintf &amp;quot;Time trigger function executed at: %A&amp;quot; DateTime.Now&#xA;    log.LogInformation msg&#xA;&#xA;    run log&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;h2&gt;The Code&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;It&amp;rsquo;s nothing fancy, but I really enjoyed writing my first real F# program. I feel like it could be factored better, but at the same time it&amp;rsquo;s still easy to read coming back to it after a few months - a testament to F# more than to my beginner code.&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;Reading JSON via the type provider&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Here&amp;rsquo;s how we create a type that represents the CDC&amp;rsquo;s vaccination:&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;type CdcData = JsonProvider&amp;lt;Sample=&amp;quot;sampleVaxData.json&amp;quot;&amp;gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;Yep, that&amp;rsquo;s it. Just give the &lt;a href=&#34;https://docs.microsoft.com/en-us/dotnet/fsharp/tutorials/type-providers/&#34;&gt;type provider&lt;/a&gt; a sample. That allows us to query it naturally, e.g., for the completed vaccination percentage for a given location:&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;let getFullyVaccinatedPercentage (vaxData: CdcData.VaccinationData array) location =&#xA;    let locationRow =&#xA;        vaxData&#xA;        |&amp;gt; Array.where (fun row -&amp;gt; row.Location = location)&#xA;        |&amp;gt; Seq.exactlyOne&#xA;&#xA;    locationRow.SeriesCompletePopPct&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;h3&gt;Testing via FsUnit&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Honestly, one of the harder part was getting the edge cases of the progress bar right :) It needs to work for all percentages and always have the same number of characters. &lt;a href=&#34;https://github.com/thomas11/covid-vax-tracker/blob/main/azure_function/twitter.fs#L6&#34;&gt;The generator function&lt;/a&gt; scales the percentage to the number of characters available and use &lt;code&gt;String.replicate&lt;/code&gt; to make the correct number of characters. I ended up writing a bunch of tests using &lt;a href=&#34;https://fsprojects.github.io/FsUnit/xUnit.html&#34;&gt;FsUnit.Xunit&lt;/a&gt;, which was a nice experience. Defining some helpers, each test is very succinct.&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;let firstNCharactersShouldBeFilled n bar =&#xA;    bar&#xA;    |&amp;gt; Seq.take n&#xA;    |&amp;gt; Seq.forall (fun c -&amp;gt; c = filled)&#xA;    |&amp;gt; should be True&#xA;&#xA;let charactersFromNShouldBeEmpty n bar =&#xA;    bar&#xA;    |&amp;gt; Seq.skip (n - 1)&#xA;    |&amp;gt; Seq.forall (fun c -&amp;gt; c = empty)&#xA;    |&amp;gt; should be True&#xA;&#xA;// The progress part should be the first n characters&#xA;let shouldBeFilledUntil n bar =&#xA;    firstNCharactersShouldBeFilled n bar&#xA;    charactersFromNShouldBeEmpty (n + 1) bar&#xA;&#xA;[&amp;lt;Fact&amp;gt;]&#xA;let ``progress bar with 0%`` () =&#xA;    progressBar 50 0.0m&#xA;    |&amp;gt; shouldBeFilledUntil 0&#xA;  &#xA;[&amp;lt;Fact&amp;gt;]&#xA;let ``progress bar of length 20 1 completed`` () =&#xA;    progressBar 20 5.0m&#xA;    |&amp;gt; shouldBeFilledUntil 1&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;Alright, the code is straightforward so I won&amp;rsquo;t repeat more of it here. Browse or check out &lt;a href=&#34;https://github.com/thomas11/covid-vax-tracker&#34;&gt;the repository&lt;/a&gt;!&lt;/p&gt;&#xA;</content>
   <category term="Programming"></category>
   <category term="F#"></category>
   <category term="Azure"></category>
  </entry>
 </feed>